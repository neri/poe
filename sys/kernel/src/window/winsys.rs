// A Window System

use crate::graphics::bitmap::*;
use crate::graphics::color::*;
use crate::graphics::coords::*;
use crate::{io::hid::*, system::System};

static mut WM: WindowManager = WindowManager::new();

const MOUSE_POINTER_WIDTH: usize = 12;
const MOUSE_POINTER_HEIGHT: usize = 20;
const MOUSE_POINTER_COLOR_KEY: IndexedColor = IndexedColor(0xFF);
const MOUSE_POINTER_SOURCE: [u8; MOUSE_POINTER_WIDTH * MOUSE_POINTER_HEIGHT] = [
    0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x0F, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x07, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x00, 0x07, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x0F, 0x00, 0x00, 0x07, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x00,
    0x07, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0F, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF,
    0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0F, 0xFF, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x07, 0x0F, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0x0F, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0F,
    0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x07,
    0x0F, 0x07, 0x00, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x00, 0x07, 0x0F, 0xFF, 0x0F, 0x00, 0x07,
    0x0F, 0xFF, 0xFF, 0xFF, 0x0F, 0x07, 0x0F, 0xFF, 0xFF, 0x0F, 0x07, 0x00, 0x0F, 0xFF, 0xFF, 0xFF,
    0x0F, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x00, 0x07, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x0F, 0x07, 0x00, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F,
    0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
];

pub struct WindowManager {
    last_key: Option<char>,
    pointer_x: isize,
    pointer_y: isize,
}

impl WindowManager {
    const fn new() -> Self {
        Self {
            last_key: None,
            pointer_x: 320,
            pointer_y: 240,
        }
    }

    #[inline]
    fn shared<'a>() -> &'a mut Self {
        unsafe { &mut WM }
    }

    pub fn post_key_event(event: KeyEvent) {
        // TODO:
        // let shared = match Self::shared_opt() {
        //     Some(v) => v,
        //     None => return,
        // };
        let shared = Self::shared();
        if let Some(event) = event.key_data() {
            shared.last_key = Some(event.into_char());
        }
    }

    pub fn post_mouse_event(mouse_state: &mut MouseState) {
        // TODO:
        // let shared = match Self::shared_opt() {
        //     Some(v) => v,
        //     None => return,
        // };
        let shared = Self::shared();

        let screen = System::main_screen();

        let mut pointer = Point::new(0, 0);
        core::mem::swap(&mut mouse_state.x, &mut pointer.x);
        core::mem::swap(&mut mouse_state.y, &mut pointer.y);
        let button_changes: MouseButton = mouse_state.current_buttons ^ mouse_state.prev_buttons;
        let button_down: MouseButton = button_changes & mouse_state.current_buttons;
        let button_up: MouseButton = button_changes & mouse_state.prev_buttons;
        let button_changed = !button_changes.is_empty();

        let mut x = shared.pointer_x + pointer.x;
        let mut y = shared.pointer_y + pointer.y;
        if x < 0 {
            x = 0;
        } else if x >= screen.width() as isize {
            x = screen.width() as isize - 1;
        }
        if y < 0 {
            y = 0;
        } else if y >= screen.height() as isize {
            y = screen.height() as isize - 1;
        }
        shared.pointer_x = x;
        shared.pointer_y = y;

        let origin = Point::new(x, y);
        let cursor = OsBitmap8::from_bytes(
            &MOUSE_POINTER_SOURCE,
            Size::new(MOUSE_POINTER_WIDTH as isize, MOUSE_POINTER_HEIGHT as isize),
        );
        screen.blt_with_key(&cursor, origin, cursor.bounds(), MOUSE_POINTER_COLOR_KEY);
    }

    pub fn get_key() -> Option<char> {
        let shared = Self::shared();
        core::mem::replace(&mut shared.last_key, None)
    }
}
